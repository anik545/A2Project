{% extends "layout.html" %}

{% block title %} Account {% endblock %}

{% block head %}
{{ super() }}

<script src="{{ url_for('static',filename='image-picker/image-picker.min.js') }}"></script>

<link rel="stylesheet" href="{{ url_for('static',filename='styles/account.css') }}">

<link rel="stylesheet" href="{{ url_for('static',filename='image-picker/image-picker.css') }}">
{% endblock %}

{% block main %}
<div id="title" class="row">
    <div class="col-sm-12">
        <div class="alert alert-info" style="margin:10px;text-align:center;">Your Account</div>
    </div>
</div>
<div data-spy="scroll" data-target=".scrollspy" style="position:relative">
<div class="col-md-3 scrollspy">
    <ul id="nav" class="nav hidden-xs hidden-sm affix-top" data-spy="affix">
        <li><a href="#links">Links</a></li>
        <li><a href="#set">Set Tasks</a></li>
        <li><a href="#graphs">Graphs</a></li>
        <li><a href="#settings">Settings</a>
            <ul id="nav">
                <li>
                    <a href="#pwd">Password</a>
                </li>
                <li>
                    <a href="#user">Username</a>
                </li>
            </ul>
        </li>
    </ul>
</div>
<div class="col-md-9">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info alert-dismissable fade in">
          <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
          {{ message }}
        </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

  <section id="links">
    <h1>Links</h1>
    <table id="links-table" class="table">
      <thead>
        <th>Name</th>
        <th></th>
      </thead>
      <tbody>
        {% for s in teacher.students.all() %}
        <tr id="link-row{{ s.student_id }}">
          <td>{{ s.fname }}&nbsp;{{ s.lname }}</td>
          <td><input type="button" id="{{ s.student_id }}" value="Delete"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h2>Current Tasks</h2>
    {% for s in students %}
      <ul>
        <li id="task-row{{ s.student_id }}">{{ s.fname }}&nbsp;{{ s.lname }}
          {% if s.tasks.first() %}
            <table class="table">
              <thead>
                <th>Topic</th>
                <th>Task Name</th>
                <th>Completed</th>
                <th>Mark</th>
                <th>Percent</th>
                <th>Date Completed</th>
              </thead>
              <tbody>
              {% for t in s.tasks.all() %}
                <tr>
                  <td>{{ qs[t.question_id]['topic'] }}</td>
                  <td>{{ qs[t.question_id]['name'] }}</td>
                  <td>{{ t.completed }}</td>
                  {% if t.mark %}
                  <td>{{ t.mark.score }}/{{ t.mark.out_of }}</td>
                  <td>{{ t.mark.score/t.mark.out_of*100 }}%</td>
                  <td>{{ t.mark.date }}</td>
                  {% endif %}
                </tr>
              {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </li>
      </ul>
    {% endfor %}
  </section>

  <section id="set">
    <h1>Set Tasks</h1>
    <form method="post", action="{{ url_for('user.account') }}">
    <div>
      <table>
      {% for student in setform.student_select %}
        <tr id="set-tasks">
        <td>{{ student.label }}</td><td>{{ student }}</td>
        </tr>
      {% endfor %}
      </table>
    </div>
    <div>
      <table>
      {% for task in setform.task_select %}
        <tr>
        <td>{{ task.label }}</td><td>{{ task }}</td>
        </tr>
      {% endfor %}
      </table>
    </div>
    {{ setform.set_submit }}
    </form>
  </section>

  <section id="graphs">
    <h1>Graphs</h1>
    <form action="{{ url_for('loci.loci') }}" method="get" id="graphform">
      <select size="5" class="image-picker show-html" id="graph-select" form="graphform" name="id">
        {% for g in teacher.graphs.all() %}
            <option data-img-label="{{ g.title }}<br>{{ g.description }}<br><button class='btn btn-block'>Load</button><br><input type='button' value='Delete' id='del-graph{{ g.graph_id }}' class='btn btn-block'>" data-img-src="{{ g.image_url }}" value="{{ g.graph_id }}"></option>
        {% endfor %}
      </select>
    </form>
  </section>

  <section id="settings">
    <h1>Settings</h1>
    <form method="post", action="{{ url_for('user.account') }}">
    {{ changeform.hidden_tag() }}
    {{ changeform.fname.label }}
    {{ changeform.fname(value=teacher.fname) }}
    <br>
    {{ changeform.lname.label }}
    {{ changeform.lname(value=teacher.lname) }}
    <br>
    {{ changeform.email.label }}
    {{ changeform.email(value=teacher.email) }}
    <br>
    {{ changeform.password.label }}
    {{ changeform.password }}
    <br>
    {{ changeform.change_submit }}
    </form>

    <form method="post", action="{{ url_for('user.account') }}">
    {{ pwform.hidden_tag() }}
    {{ pwform.old_password.label }}
    {{ pwform.old_password }}
    <br>
    {{ pwform.password.label }}
    {{ pwform.password }}
    <br>
    {{ pwform.confirm_password.label }}
    {{ pwform.confirm_password }}
    <br>
    {{ pwform.pw_submit }}
    </form>
  </section>
</div>
</div>
</div>
{% endblock %}

{% block endscripts %}
<script>
    $SCRIPT_ROOT = {{ request.script_root | tojson | safe }};
    $('#nav').affix({
        offset: {
            top: $('#nav').offset().top
        }
    });
    $('#nav').affix({
        offset: {
            bottom: ($('footer').outerHeight(true) +
                    $('.application').outerHeight(true)) +
                    40
        }
    });
    $('#graph-select').imagepicker({show_label:true})
    $('#links-table').on('click','[type=button]',function(){
      if (confirm('Are you sure')) {
        student_id = $(this).attr('id');
        // Send data of student to be deleted to server
        $.post($SCRIPT_ROOT + '/_delete_student',{
          student_id:student_id
        },function(data){
          // Delete all other references to this student on account page
          $('#link-row'+student_id).remove()
          $('#task-row'+student_id).remove()
          $('input[type="checkbox"][value="'+student_id+'"]').parents('tr').remove()
        }).fail(function(){
          // Show error message if there is a server error
          alert('Error deleting Student')
        });
      }
    });
    $('input[type="button"][id*="del-graph"]').on('click',function(){
      if (confirm('Are you sure')) {
        graph_id = $(this).attr('id').replace('del-graph','');
        // Send data of student to be deleted to server
        $.post($SCRIPT_ROOT + '/_delete_graph',{
          graph_id:graph_id
        },function(data){
          $('option[value="'+graph_id+'"]').remove()
          $('#graph-select').imagepicker({show_label:true})
        }).fail(function(){
          // Show error message if there is a server error
          alert('Error Deleting Graph')
        });
      }
    });

</script>

{% endblock %}
